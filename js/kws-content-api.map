{"version":3,"file":"bundle.js","sources":["../node_modules/grunt-browserify/node_modules/browserify/node_modules/browser-pack/_prelude.js","../lib/index.js","../lib/KwsContentUploader.js","../lib/KwsWebRtcContent.js","../lib/KwsContentPlayer.js","../lib/Content.js","../node_modules/grunt-browserify/node_modules/browserify/node_modules/events/events.js","../node_modules/xmlhttprequest/lib/browser.js","../node_modules/inherits/inherits_browser.js","../node_modules/kws-rpc-builder/lib/index.js","../node_modules/kws-rpc-builder/lib/Mapper.js","../node_modules/kws-rpc-builder/lib/packers/index.js","../node_modules/kws-rpc-builder/lib/clients/index.js","../node_modules/kws-rpc-builder/lib/packers/JsonRPC.js","../node_modules/kws-rpc-builder/lib/packers/XmlRPC.js","../node_modules/kws-rpc-builder/lib/clients/jsonrpcclient.js","../node_modules/kws-rpc-builder/node_modules/ws/lib/browser.js"],"names":["KwsContentPlayer","require","KwsContentUploader","KwsWebRtcContent","exports","drop","event","stopPropagation","preventDefault","this","_filesContainer","dataTransfer","dragover","dropEffect","url","options","sendFiles","container","files","self","send","doSend","file","xhr","XMLHttpRequest","upload","addEventListener","error","emit","console","log","open","success","result","inputTag","input","document","getElementById","SyntaxError","dragdropTag","div","filesContainer","undefined","autostart","Content","call","Content_start","start","params","constraints","audio","video","sessionId","FileList","lenght","f","formData","FormData","i","append","useFormData","inherits","initDragDrop","id","module","onerror","initRtc","localStream","iceServers","pc","RTCPeerConnection","optional","DtlsSrtpKeyAgreement","addStream","mediaConstraints","mandatory","OfferToReceiveAudio","_audio","remote","OfferToReceiveVideo","_video","createOffer","offer","setLocalDescription","info","onicecandidate","candidate","sdp","localDescription","debug","onsignalingstatechange","signalingState","setRemoteDescription","RTCSessionDescription","type","success2","local","stream","getLocalStreams","Error","URL","createObjectURL","localVideoTag","localVideo","msg","muted","src","getRemoteStreams","remoteVideoTag","_setRemoteVideoTag","warn","close","on","getUserMedia","remoteVideo","terminate","reason","REASON_SERVER_ENDED_SESSION","removeAttribute","decodeMode","RangeError","setSessionId","TypeError","_sessionId","doRPC","method","callback","rpc","encode","decode","responseText","pollMediaEvents","error_tries","contentEvents","data","controlEvents","terminatedByServer","pollingTimeout","clearTimeout","setTimeout","failure","code","MAX_ALLOWED_ERROR_TRIES","Math","pow","terminateConnection","polling","startPolling","action","EventEmitter","ERROR_NO_REMOTE_VIDEO_TAG","maxFrameRate","MAX_FRAMERATE","__defineGetter__","RpcBuilder","JsonRPC","request_timeout","rejected","execute","command","commandResult","REASON_USER_ENDED_SESSION","packers","message","_events","_maxListeners","isFunction","arg","isNumber","isObject","isUndefined","prototype","defaultMaxListeners","setMaxListeners","n","isNaN","er","handler","len","args","listeners","length","arguments","Array","apply","slice","addListener","listener","m","newListener","push","warned","trace","once","g","removeListener","fired","list","position","splice","removeAllListeners","key","ret","listenerCount","emitter","Object","create","ctor","superCtor","super_","constructor","value","enumerable","writable","configurable","TempCtor","unifyResponseMethods","responseMethods","response","unifyTransport","transport","Function","postMessage","write","onmessage","pause","RpcNotification","defineProperty","packer","onRequest","transportMessage","storeResponse","dest","timeout","responses","remove","response_timeout","set","storeProcessedResponse","ack","from","processedResponses","duplicates_timeout","RpcRequest","get","Boolean","responseMethod","pack","bind","reply","peerID","cancel","message2Key","request","requests","pop","unpack","max_retries","removeEventListener","BASE_TIMEOUT","requestID","Mapper","forEach","dispatchCallback","sendRequest","retried","encode_transport","retry","processRequest","idAck","processResponse","duplicatedResponse","e","notification","processed","clients","sources","source","key2","ids","keys","XmlRPC","JsonRpcClient","jsonrpc","JSON","stringify","String","parse","version","result_defined","error_defined","wsUrl","ws","WebSocket","uri","protocols","instance","global","MozWebSocket"],"mappings":"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","sourcesContent":["(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error(\"Cannot find module '\"+o+\"'\")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})","/*\n * (C) Copyright 2013 Kurento (http://kurento.org/)\n *\n * All rights reserved. This program and the accompanying materials\n * are made available under the terms of the GNU Lesser General Public License\n * (LGPL) version 2.1 which accompanies this distribution, and is available at\n * http://www.gnu.org/licenses/lgpl-2.1.html\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n * Lesser General Public License for more details.\n *\n */\n\n/**\n * @module kwsContentApi\n *\n * @copyright 2013 Kurento (http://kurento.org/)\n * @license LGPL\n */\n\nvar KwsContentPlayer   = require('./KwsContentPlayer');\nvar KwsContentUploader = require('./KwsContentUploader');\nvar KwsWebRtcContent   = require('./KwsWebRtcContent');\n\n\nexports.KwsContentPlayer   = KwsContentPlayer;\nexports.KwsContentUploader = KwsContentUploader;\nexports.KwsWebRtcContent   = KwsWebRtcContent;","/*\n * (C) Copyright 2013 Kurento (http://kurento.org/)\n *\n * All rights reserved. This program and the accompanying materials\n * are made available under the terms of the GNU Lesser General Public License\n * (LGPL) version 2.1 which accompanies this distribution, and is available at\n * http://www.gnu.org/licenses/lgpl-2.1.html\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n * Lesser General Public License for more details.\n *\n */\n\n\n/*\n * @module kwsContentApi\n */\n\nvar Content = require(\"./Content\");\n\nvar inherits       = require(\"inherits\");\nvar XMLHttpRequest = require(\"xmlhttprequest\");\n\n\nfunction drop(event)\n{\n  event.stopPropagation();\n  event.preventDefault();\n\n  this._filesContainer = event.dataTransfer;\n};\nfunction dragover(event)\n{\n  event.stopPropagation();\n  event.preventDefault();\n\n  event.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.\n};\n\n/**\n * Upload a file to a Media Server\n * \n * @constructor\n * @extend Content\n * \n * @param {string} url - URL of the Connect Server endpoint\n * @param {KwsContentUploader} [options]\n */\nfunction KwsContentUploader(url, options)\n{\n  options = options || {};\n\n  if(options.autostart == undefined)\n     options.autostart = true;\n\n  Content.call(this, url, options);\n\n  var self = this;\n\n  var Content_start = this.start;\n\n\n  function sendFiles(container)\n  {\n    var files = container.files;\n    if(files)\n      self.send(files);\n  };\n\n\n  var url;\n\n  function doSend(file)\n  {\n    // XmlHttpRequest object used to upload the files\n    var xhr = new XMLHttpRequest();\n\n    xhr.upload.addEventListener('error', function(error)\n    {\n      self.emit('error', error);\n    });\n    xhr.upload.addEventListener('load', function(event)\n    {\n      console.log(event);\n      self.emit('localfile');\n//      self.emit('localfile', file);\n    });\n\n    // Connect to Media Server\n    xhr.open('POST', url);\n\n    // Send the file\n    xhr.send(file);\n  };\n\n\n  function success(result)\n  {\n    // Set the url where to upload the file\n    url = result.url;\n\n    //\n    // Set events on elements (if specified)\n    //\n\n    // Input tag\n    var inputTag = options.inputTag;\n    if(inputTag)\n    {\n      var input = document.getElementById(inputTag);\n      if(!input)\n        throw new SyntaxError(\"ID \"+inputTag+\" was not found\");\n\n      input.addEventListener('change', function(event)\n      {\n        sendFiles(input);\n      });\n\n      // Send previously selected files\n      sendFiles(input);\n    };\n\n    // Drag & Drop area\n    var dragdropTag = options.dragdropTag;\n    if(dragdropTag)\n    {\n      var div = document.getElementById(dragdropTag);\n      if(!div)\n        throw new SyntaxError(\"ID \"+dragdropTag+\" was not found\");\n\n      // Set events if they were not set before\n      div.addEventListener('drop', drop);\n      div.addEventListener('dragover', dragover);\n\n      // Send previously dropped files\n      var filesContainer = div._filesContainer;\n      if(filesContainer)\n        sendFiles(filesContainer);\n    };\n\n    self.emit('start');\n  };\n\n\n  /**\n   * Request to the content server the URL where to upload the file\n   */\n  this.start = function()\n  {\n    var params =\n    {\n      constraints:\n      {\n        audio: 'sendonly',\n        video: 'sendonly'\n      }\n    };\n\n    Content_start.call(self, params, success);\n  };\n\n  if(options.autostart)\n    this.start();\n\n\n  //\n  // Methods\n  //\n\n  /**\n   * Upload a file\n   * \n   * @param {File} file - media file to be uploaded to the server\n   */\n  this.send = function(file)\n  {\n    if(!this.sessionId)\n      throw new SyntaxError(\"Connection with media server is not stablished\");\n\n    // Fileset\n    if(file instanceof FileList)\n    {\n      // Fileset with several files\n      if(file.lenght > 1)\n      {\n        var formData = new FormData();\n        for(var i=0, f; f=file[i]; i++)\n          formData.append(\"file_\"+i, f);\n        file = formData;\n      }\n\n      // Fileset with zero or one files\n      else\n        file = file[0];\n    }\n\n    // Forced usage of FormData\n    else if(options.useFormData)\n    {\n      var formData = new FormData();\n      formData.append(\"file\", file);\n      file = formData;\n    }\n\n    // Send the file\n    doSend(file);\n  };\n};\ninherits(KwsContentUploader, Content);\n\n\nKwsContentUploader.initDragDrop = function(id)\n{\n  var div = document.getElementById(id);\n  if(!div)\n    throw new SyntaxError(\"ID \"+id+\" was not found\");\n\n  div.addEventListener('drop', drop);\n  div.addEventListener('dragover', dragover);\n};\n\n\n/**\n * @typedef {object} KwsContentUploader\n * @property {Boolean} [useFormData] - select if files should be uploaded as raw\n *   Blobs or inside a FormData object\n * @property {string} [inputTag] - ID of the input tag that will host the file\n * @property {string} [dragdropTag] - ID of the element where to drop the files\n */\n\n\nmodule.exports = KwsContentUploader;\n","/*\n * (C) Copyright 2013 Kurento (http://kurento.org/)\n *\n * All rights reserved. This program and the accompanying materials\n * are made available under the terms of the GNU Lesser General Public License\n * (LGPL) version 2.1 which accompanies this distribution, and is available at\n * http://www.gnu.org/licenses/lgpl-2.1.html\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n * Lesser General Public License for more details.\n *\n */\n\n\nvar Content = require(\"./Content\");\n\nvar inherits = require(\"inherits\");\n\n\n/**\n * @constructor\n *\n * @param {String} url: URL of the WebRTC endpoint server.\n * @param {Object} options: optional configuration parameters\n *   {Enum('inactive', 'sendonly', 'recvonly', 'sendrecv')} audio: audio stream mode\n *   {Enum('inactive', 'sendonly', 'recvonly', 'sendrecv')} video: video stream mode\n *   {[Object]} iceServers: array of objects to initialize the ICE servers. It\n *     structure is the same as an Array of WebRTC RTCIceServer objects.\n *\n * @throws RangeError\n */\nfunction KwsWebRtcContent(url, options)\n{\n  options = options || {};\n\n  if(options.autostart == undefined)\n     options.autostart = true;\n\n  Content.call(this, url, options);\n\n  var self = this;\n\n  var Content_start = this.start;\n\n\n  var pc = null;\n\n\n  function onerror(error)\n  {\n    self.emit('error', error);\n  };\n\n\n  /**\n   * Request a connection with the webRTC endpoint server\n   *\n   * @private\n   *\n   * @param {MediaStream | undefined} localStream: stream locally offered\n   */\n  function initRtc(localStream)\n  {\n    if(localStream)\n      console.log('User has granted access to local media.');\n\n    // Create the PeerConnection object\n    var iceServers = options.iceServers\n                  || [{url: 'stun:'+'stun.l.google.com:19302'}];\n\n    pc = new RTCPeerConnection\n    (\n      {iceServers: iceServers},\n      {optional: [{DtlsSrtpKeyAgreement: true}]}\n    );\n\n    // Add the local stream if defined\n    if(localStream)\n      pc.addStream(localStream);\n\n    var mediaConstraints =\n    {\n      mandatory:\n      {\n        OfferToReceiveAudio: self._audio.remote,\n        OfferToReceiveVideo: self._video.remote\n      }\n    };\n\n    pc.createOffer(function(offer)\n    {\n      // Set the peer local description\n      pc.setLocalDescription(offer,\n      function()\n      {\n        console.info(\"LocalDescription correctly set\");\n      },\n      onerror);\n    },\n    onerror,\n    mediaConstraints);\n\n    // PeerConnection events\n\n    pc.onicecandidate = function(event)\n    {\n      // We are still generating the candidates, don't send the SDP yet.\n      if(event.candidate) return;\n\n      var params =\n      {\n        sdp: pc.localDescription.sdp,\n        constraints:\n        {\n          audio: options.audio,\n          video: options.video\n        }\n      };\n\n      console.debug('offer: '+params.sdp);\n\n      Content_start.call(self, params, success);\n    };\n\n    // Dispatch 'close' event if signaling gets closed\n    pc.onsignalingstatechange = function(event)\n    {\n      if(pc.signalingState == \"closed\")\n        self.emit('terminate');\n    };\n  }\n\n\n  /**\n   * Callback when connection is succesful\n   *\n   * @private\n   *\n   * @param {Object} response: JsonRPC response\n   */\n  function success(result)\n  {\n    console.debug('answer: '+result.sdp);\n\n    // Set answer description and init local environment\n    pc.setRemoteDescription(new RTCSessionDescription(\n    {\n      type: 'answer',\n      sdp: result.sdp\n    }),\n    success2,\n    onerror);\n  };\n\n  function success2()\n  {\n    // Local streams\n    if(self._video.local)\n    {\n      var stream = pc.getLocalStreams()[0];\n      if(!stream)\n        return onerror(new Error(\"No local streams are available\"));\n\n      var url = URL.createObjectURL(stream);\n\n      if(options.localVideoTag)\n      {\n        var localVideo = document.getElementById(options.localVideoTag);\n        if(!localVideo)\n        {\n          var msg = \"Requested local video tag '\"+options.localVideoTag\n                  + \"' is not available\";\n          return onerror(new Error(msg));\n        };\n\n        localVideo.muted = true;\n        localVideo.src = url;\n      };\n\n      self.emit('localstream', {stream: stream, url: url});\n    };\n\n    // Remote streams\n    if(self._video.remote)\n    {\n      var stream = pc.getRemoteStreams()[0];\n      if(!stream)\n        return self.emit('error', new Error(\"No remote streams are available\"));\n\n      var url = URL.createObjectURL(stream);\n\n      if(options.remoteVideoTag)\n      {\n        var remoteVideo = self._setRemoteVideoTag(url);\n\n      }\n      else\n        console.warn(\"No remote video tag available, successful terminate event due to remote end will be no dispatched\");\n\n      self.emit('remotestream', {stream: stream, url: url});\n    };\n\n    // Notify we created the connection successfully\n    self.emit('start');\n  };\n\n\n  /**\n   * Terminate the connection with the WebRTC media server\n   */\n  function close()\n  {\n    if(pc.signalingState == \"closed\")\n      return;\n\n    // Close the PeerConnection\n    pc.close();\n  };\n\n  this.on('error',     close);\n  this.on('terminate', close);\n\n\n  // Mode set to send local audio and/or video stream\n  this.start = function()\n  {\n    var audio = this._audio.local;\n    var video = this._video.local;\n\n    if(audio || video)\n    {\n      var constraints =\n      {\n        audio: audio,\n        video: video\n      };\n\n      getUserMedia(constraints, initRtc, onerror);\n    }\n\n    // Mode set to only receive a stream, not send it\n    else\n      initRtc();\n  }\n\n  if(options.autostart)\n    this.start();\n};\ninherits(KwsWebRtcContent, Content);\n\n\nmodule.exports = KwsWebRtcContent;\n","/*\n * (C) Copyright 2013 Kurento (http://kurento.org/)\n *\n * All rights reserved. This program and the accompanying materials\n * are made available under the terms of the GNU Lesser General Public License\n * (LGPL) version 2.1 which accompanies this distribution, and is available at\n * http://www.gnu.org/licenses/lgpl-2.1.html\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n * Lesser General Public License for more details.\n *\n */\n\n\nvar Content = require(\"./Content\");\n\nvar inherits = require(\"inherits\");\n\n\n/**\n * @constructor\n *\n * @param {String} url: URL of the WebRTC endpoint server.\n * @param {Object} options: optional configuration parameters\n *   {Enum('inactive', 'sendonly', 'recvonly', 'sendrecv')} audio: audio stream mode\n *   {Enum('inactive', 'sendonly', 'recvonly', 'sendrecv')} video: video stream mode\n *   {[Object]} iceServers: array of objects to initialize the ICE servers. It\n *     structure is the same as an Array of WebRTC RTCIceServer objects.\n *   {Boolean} [autostart=true]: flag to manually start media\n *\n * @throws RangeError\n */\nfunction KwsContentPlayer(url, options)\n{\n  options = options || {};\n\n  if(options.autostart == undefined)\n     options.autostart = true;\n\n  Content.call(this, url, options);\n\n  var self = this;\n\n  var Content_start = this.start;\n\n\n  /**\n   * Callback when connection is succesful\n   *\n   * @private\n   *\n   * @param {Object} response: JsonRPC response\n   */\n  function success(result)\n  {\n    // Remote streams\n    if(self._video.remote)\n    {\n      var url = result.url;\n\n      if(options.remoteVideoTag)\n      {\n        var remoteVideo = self._setRemoteVideoTag(url);\n\n        remoteVideo.addEventListener('ended', function()\n        {\n          self.terminate();\n        })\n      }\n      else\n        console.warn(\"No remote video tag available, successful terminate event due to remote end will be no dispatched\");\n\n      self.emit('remotestream', {url: url});\n    };\n\n    // Notify we created the connection successfully\n    self.emit('start');\n  };\n\n\n  // RPC calls\n\n  // Start\n\n  /**\n   * Request a connection with the webRTC endpoint server\n   *\n   * @private\n   */\n  this.start = function()\n  {\n    var params =\n    {\n      constraints:\n      {\n        audio: options.audio,\n        video: options.video\n      }\n    };\n\n    Content_start.call(self, params, success);\n  };\n\n  if(options.autostart)\n    this.start();\n\n\n  function close(reason)\n  {\n    if(reason == Content.REASON_SERVER_ENDED_SESSION)\n      return;\n\n    var remoteVideo = document.getElementById(options.remoteVideoTag);\n    if(remoteVideo) {\n        remoteVideo.src = '';\n        remoteVideo.removeAttribute('src');\n    }\n  };\n\n  this.on('error',     close);\n  this.on('terminate', close);\n};\ninherits(KwsContentPlayer, Content);\n\n\nmodule.exports = KwsContentPlayer;\n","/*\n * (C) Copyright 2013 Kurento (http://kurento.org/)\n *\n * All rights reserved. This program and the accompanying materials\n * are made available under the terms of the GNU Lesser General Public License\n * (LGPL) version 2.1 which accompanies this distribution, and is available at\n * http://www.gnu.org/licenses/lgpl-2.1.html\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n * Lesser General Public License for more details.\n *\n */\n\n\nvar EventEmitter = require(\"events\").EventEmitter;\nvar inherits     = require('inherits');\n\nvar XMLHttpRequest = require(\"xmlhttprequest\");\n\nvar RpcBuilder     = require(\"kws-rpc-builder\");\nvar JsonRPC        = RpcBuilder.packers.JsonRPC;\n\n\nconst MAX_FRAMERATE = 15;\n\n\n/**\n * @constructor\n * @abstract\n *\n * @param {String} url: URL of the WebRTC endpoint server.\n * @param {Object} options: optional configuration parameters\n *   {Enum('inactive', 'sendonly', 'recvonly', 'sendrecv')} audio: audio stream mode\n *   {Enum('inactive', 'sendonly', 'recvonly', 'sendrecv')} video: video stream mode\n *   {[Object]} iceServers: array of objects to initialize the ICE servers. It\n *     structure is the same as an Array of WebRTC RTCIceServer objects.\n *\n * @throws RangeError\n */\nfunction Content(url, options)\n{\n  EventEmitter.call(this);\n\n  var self = this;\n\n\n  const ERROR_NO_REMOTE_VIDEO_TAG = -1;\n\n\n  /**\n   * Decode the mode of the streams\n   *\n   * @private\n   *\n   * @param {Object} options: constraints to update and decode\n   * @param {String} type: name of the constraints to decode\n   *\n   * @returns {Object}\n   *\n   * @throws RangeError\n   */\n  function decodeMode(options, type)\n  {\n    var result = {};\n\n    // If not defined, set send & receive by default\n    options[type] = options[type] || 'sendrecv';\n\n    switch(options[type])\n    {\n      case 'sendrecv':\n        result.local  = true;\n        result.remote = true;\n      break;\n\n      case 'sendonly':\n        result.local  = true;\n        result.remote = false;\n      break;\n\n      case 'recvonly':\n        result.local  = false;\n        result.remote = true;\n      break;\n\n      case 'inactive':\n        result.local  = false;\n        result.remote = false;\n      break;\n\n      default:\n        throw new RangeError(\"Invalid \"+type+\" media mode\");\n    }\n\n    return result;\n  }\n\n  // We can't disable both audio and video on a stream, raise error\n  if(options.audio == 'inactive' && options.video == 'inactive')\n    throw new RangeError(\"At least one audio or video must to be enabled\");\n\n  // Audio media\n  this._audio = decodeMode(options, \"audio\");\n\n  // Video media\n  this._video = decodeMode(options, \"video\");\n\n  if(this._video.local)\n      this._video.local =\n      {\n        mandatory:\n        {\n//          minHeight   : options.minHeight    || MIN_HEIGHT,\n//          maxHeight   : options.maxHeight    || MAX_HEIGHT,\n//          minWidth    : options.minWidth     || MIN_WIDTH,\n//          maxWidth    : options.maxWidth     || MAX_WIDTH,\n//          minFrameRate: options.minFrameRate || MIN_FRAMERATE,\n          maxFrameRate: options.maxFrameRate || MAX_FRAMERATE\n        }\n      };\n\n  // Init the KwsWebRtcContent object\n\n  var _sessionId = null;\n  var pollingTimeout = null;\n  var polling = false;\n  var terminatedByServer = false;\n\n\n  this.__defineGetter__('sessionId', function()\n  {\n    return _sessionId;\n  });\n\n\n  function setSessionId(sessionId)\n  {\n    if(sessionId == undefined)\n      throw new TypeError('sessionId is undefined');\n\n    if(_sessionId == undefined)\n      _sessionId = sessionId;\n\n    else if(sessionId != _sessionId)\n      throw new TypeError('sessionId is not equal to already defined one');\n  }\n\n\n  var rpc = new RpcBuilder(JsonRPC,\n                           {request_timeout: options.request_timeout || 30000});\n\n\n  function doRPC(method, params, callback)\n  {\n    var xhr = new XMLHttpRequest();\n\n    // Set XmlHttpRequest error callback\n    xhr.addEventListener('error', function(error)\n    {\n      self.emit('error', error);\n    });\n\n    // Connect to Content Server\n    xhr.open('POST', url);\n\n    // Send request\n    xhr.send(rpc.encode(method, params, callback));\n\n    // Register callback for the Application Server\n    xhr.addEventListener('load', function()\n    {\n      rpc.decode(this.responseText);\n    });\n  };\n\n\n  function close()\n  {\n//    xhr.abort();\n\n    _sessionId = null;\n  };\n\n  self.on('error',     close);\n  self.on('terminate', close);\n\n\n  // Error dispatcher functions\n\n  var MAX_ALLOWED_ERROR_TRIES = 10;\n\n  var error_tries = 0;\n\n\n  // RPC calls\n\n  // Start\n\n  this.start = function(params, success)\n  {\n    if(this.sessionId)\n      params.sessionId = this.sessionId;\n\n    doRPC('start', params, function(error, result)\n    {\n      error = error || result.rejected;\n\n      if(error) return self.emit('error', error);\n\n      setSessionId(result.sessionId);\n\n      success(result);\n    });\n  };\n\n\n  // Poll\n\n  /**\n   * Poll for events dispatched on the server pipeline\n   *\n   * @private\n   */\n  function pollMediaEvents()\n  {\n    if(!self.sessionId) return;\n\n    if(!polling) return;\n\n    var params =\n    {\n      sessionId: self.sessionId\n    };\n\n    function success(result)\n    {\n      error_tries = 0;\n\n      // Content events\n      if(result.contentEvents)\n        for(var i=0, data; data=result.contentEvents[i]; i++)\n          self.emit('mediaevent', data);\n\n      // Control events\n      if(result.controlEvents)\n        for(var i=0, data; data=result.controlEvents[i]; i++)\n        {\n          var type = data.type;\n\n          switch(type)\n          {\n            case \"sessionTerminated\":\n              terminatedByServer = true;\n              self.emit('terminate', Content.REASON_SERVER_ENDED_SESSION);\n            break;\n\n            case \"sessionError\":\n              self.emit('error', data.data);\n            break;\n\n            default:\n              console.warn(\"Unknown control event type: \"+type);\n          }\n        };\n\n      // Check if we should keep polling events\n      if(pollingTimeout != 'stopped')\n      {\n        clearTimeout(pollingTimeout);\n        pollingTimeout = setTimeout(pollMediaEvents, 0);\n      }\n    };\n\n    function failure(error)\n    {\n      // A poll error has occurred, retry it\n      if(error.code != -32602 && error_tries < MAX_ALLOWED_ERROR_TRIES)\n      {\n        if(pollingTimeout != 'stopped')\n        {\n          clearTimeout(pollingTimeout);\n          pollingTimeout = setTimeout(pollMediaEvents, Math.pow(2, error_tries)*1000);\n        }\n\n        error_tries++;\n      }\n\n      // Max number of poll errors achieved, raise error\n      else\n        terminateConnection('error', error);\n    };\n\n    doRPC('poll', params, function(error, result)\n    {\n      if(error) return failure(error);\n\n      success(result);\n    });\n  };\n\n  function startPolling()\n  {\n    if(polling) return;\n\n    polling = true;\n    pollMediaEvents()\n  };\n\n  this.on('start',   startPolling);\n  this.on('execute', startPolling);\n\n\n  /**\n   * Terminate the connection with the WebRTC media server\n   */\n  function terminateConnection(action, reason)\n  {\n    // Stop polling\n    clearTimeout(pollingTimeout);\n    pollingTimeout = 'stopped';\n    polling = false;\n\n    if(terminatedByServer)\n      return;\n\n    // Notify to the WebRTC endpoint server\n    if(self.sessionId)\n    {\n      var params =\n      {\n        sessionId: self.sessionId,\n        reason: reason\n      };\n\n      doRPC('terminate', params, function()\n      {\n        self.emit(action, reason);\n      });\n\n      _sessionId = null;\n    };\n  };\n\n\n  //\n  // Methods\n  //\n\n  /**\n   * @private\n   */\n  this._setRemoteVideoTag = function(src)\n  {\n    var remoteVideo = document.getElementById(options.remoteVideoTag);\n    if(remoteVideo)\n    {\n      remoteVideo.src = src;\n\n      return remoteVideo;\n    };\n\n    var msg = \"Requested remote video tag '\" + options.remoteVideoTag\n            + \"' is not available\";\n\n    var error = new Error(msg);\n        error.code = ERROR_NO_REMOTE_VIDEO_TAG;\n\n    self.emit('error', error);\n  };\n\n\n  /**\n   * Send a command to be executed on the server\n   *\n   * @param {string} type - The command to execute\n   * @param {*} data - Data needed by the command\n   * @param {} callback - Function executed after getting a result or an error\n   */\n  this.execute = function(type, data, callback)\n  {\n    callback = callback || function(){};\n\n    var params =\n    {\n      command:\n      {\n        type: type,\n        data: data\n      }\n    };\n\n    if(this.sessionId)\n      params.sessionId = this.sessionId;\n\n    doRPC('execute', params, function(error, result)\n    {\n      if(error) return callback(error);\n\n      setSessionId(result.sessionId);\n\n      self.emit('execute');\n      callback(null, result.commandResult);\n    });\n  }\n\n  /**\n   * Close the connection\n   */\n  this.terminate = function()\n  {\n    terminateConnection('terminate', Content.REASON_USER_ENDED_SESSION);\n  };\n};\ninherits(Content, EventEmitter);\n\n\nContent.REASON_USER_ENDED_SESSION =\n{\n  code: 1,\n  message: \"User ended session\"\n};\nContent.REASON_SERVER_ENDED_SESSION =\n{\n  code: 2,\n  message: \"Server ended session\"\n};\n\n\nmodule.exports = Content;\n","// Copyright Joyent, Inc. and other Node contributors.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a\n// copy of this software and associated documentation files (the\n// \"Software\"), to deal in the Software without restriction, including\n// without limitation the rights to use, copy, modify, merge, publish,\n// distribute, sublicense, and/or sell copies of the Software, and to permit\n// persons to whom the Software is furnished to do so, subject to the\n// following conditions:\n//\n// The above copyright notice and this permission notice shall be included\n// in all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS\n// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN\n// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR\n// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE\n// USE OR OTHER DEALINGS IN THE SOFTWARE.\n\nfunction EventEmitter() {\n  this._events = this._events || {};\n  this._maxListeners = this._maxListeners || undefined;\n}\nmodule.exports = EventEmitter;\n\n// Backwards-compat with node 0.10.x\nEventEmitter.EventEmitter = EventEmitter;\n\nEventEmitter.prototype._events = undefined;\nEventEmitter.prototype._maxListeners = undefined;\n\n// By default EventEmitters will print a warning if more than 10 listeners are\n// added to it. This is a useful default which helps finding memory leaks.\nEventEmitter.defaultMaxListeners = 10;\n\n// Obviously not all Emitters should be limited to 10. This function allows\n// that to be increased. Set to zero for unlimited.\nEventEmitter.prototype.setMaxListeners = function(n) {\n  if (!isNumber(n) || n < 0 || isNaN(n))\n    throw TypeError('n must be a positive number');\n  this._maxListeners = n;\n  return this;\n};\n\nEventEmitter.prototype.emit = function(type) {\n  var er, handler, len, args, i, listeners;\n\n  if (!this._events)\n    this._events = {};\n\n  // If there is no 'error' event listener then throw.\n  if (type === 'error') {\n    if (!this._events.error ||\n        (isObject(this._events.error) && !this._events.error.length)) {\n      er = arguments[1];\n      if (er instanceof Error) {\n        throw er; // Unhandled 'error' event\n      }\n      throw TypeError('Uncaught, unspecified \"error\" event.');\n    }\n  }\n\n  handler = this._events[type];\n\n  if (isUndefined(handler))\n    return false;\n\n  if (isFunction(handler)) {\n    switch (arguments.length) {\n      // fast cases\n      case 1:\n        handler.call(this);\n        break;\n      case 2:\n        handler.call(this, arguments[1]);\n        break;\n      case 3:\n        handler.call(this, arguments[1], arguments[2]);\n        break;\n      // slower\n      default:\n        len = arguments.length;\n        args = new Array(len - 1);\n        for (i = 1; i < len; i++)\n          args[i - 1] = arguments[i];\n        handler.apply(this, args);\n    }\n  } else if (isObject(handler)) {\n    len = arguments.length;\n    args = new Array(len - 1);\n    for (i = 1; i < len; i++)\n      args[i - 1] = arguments[i];\n\n    listeners = handler.slice();\n    len = listeners.length;\n    for (i = 0; i < len; i++)\n      listeners[i].apply(this, args);\n  }\n\n  return true;\n};\n\nEventEmitter.prototype.addListener = function(type, listener) {\n  var m;\n\n  if (!isFunction(listener))\n    throw TypeError('listener must be a function');\n\n  if (!this._events)\n    this._events = {};\n\n  // To avoid recursion in the case that type === \"newListener\"! Before\n  // adding it to the listeners, first emit \"newListener\".\n  if (this._events.newListener)\n    this.emit('newListener', type,\n              isFunction(listener.listener) ?\n              listener.listener : listener);\n\n  if (!this._events[type])\n    // Optimize the case of one listener. Don't need the extra array object.\n    this._events[type] = listener;\n  else if (isObject(this._events[type]))\n    // If we've already got an array, just append.\n    this._events[type].push(listener);\n  else\n    // Adding the second element, need to change to array.\n    this._events[type] = [this._events[type], listener];\n\n  // Check for listener leak\n  if (isObject(this._events[type]) && !this._events[type].warned) {\n    var m;\n    if (!isUndefined(this._maxListeners)) {\n      m = this._maxListeners;\n    } else {\n      m = EventEmitter.defaultMaxListeners;\n    }\n\n    if (m && m > 0 && this._events[type].length > m) {\n      this._events[type].warned = true;\n      console.error('(node) warning: possible EventEmitter memory ' +\n                    'leak detected. %d listeners added. ' +\n                    'Use emitter.setMaxListeners() to increase limit.',\n                    this._events[type].length);\n      if (typeof console.trace === 'function') {\n        // not supported in IE 10\n        console.trace();\n      }\n    }\n  }\n\n  return this;\n};\n\nEventEmitter.prototype.on = EventEmitter.prototype.addListener;\n\nEventEmitter.prototype.once = function(type, listener) {\n  if (!isFunction(listener))\n    throw TypeError('listener must be a function');\n\n  var fired = false;\n\n  function g() {\n    this.removeListener(type, g);\n\n    if (!fired) {\n      fired = true;\n      listener.apply(this, arguments);\n    }\n  }\n\n  g.listener = listener;\n  this.on(type, g);\n\n  return this;\n};\n\n// emits a 'removeListener' event iff the listener was removed\nEventEmitter.prototype.removeListener = function(type, listener) {\n  var list, position, length, i;\n\n  if (!isFunction(listener))\n    throw TypeError('listener must be a function');\n\n  if (!this._events || !this._events[type])\n    return this;\n\n  list = this._events[type];\n  length = list.length;\n  position = -1;\n\n  if (list === listener ||\n      (isFunction(list.listener) && list.listener === listener)) {\n    delete this._events[type];\n    if (this._events.removeListener)\n      this.emit('removeListener', type, listener);\n\n  } else if (isObject(list)) {\n    for (i = length; i-- > 0;) {\n      if (list[i] === listener ||\n          (list[i].listener && list[i].listener === listener)) {\n        position = i;\n        break;\n      }\n    }\n\n    if (position < 0)\n      return this;\n\n    if (list.length === 1) {\n      list.length = 0;\n      delete this._events[type];\n    } else {\n      list.splice(position, 1);\n    }\n\n    if (this._events.removeListener)\n      this.emit('removeListener', type, listener);\n  }\n\n  return this;\n};\n\nEventEmitter.prototype.removeAllListeners = function(type) {\n  var key, listeners;\n\n  if (!this._events)\n    return this;\n\n  // not listening for removeListener, no need to emit\n  if (!this._events.removeListener) {\n    if (arguments.length === 0)\n      this._events = {};\n    else if (this._events[type])\n      delete this._events[type];\n    return this;\n  }\n\n  // emit removeListener for all listeners on all events\n  if (arguments.length === 0) {\n    for (key in this._events) {\n      if (key === 'removeListener') continue;\n      this.removeAllListeners(key);\n    }\n    this.removeAllListeners('removeListener');\n    this._events = {};\n    return this;\n  }\n\n  listeners = this._events[type];\n\n  if (isFunction(listeners)) {\n    this.removeListener(type, listeners);\n  } else {\n    // LIFO order\n    while (listeners.length)\n      this.removeListener(type, listeners[listeners.length - 1]);\n  }\n  delete this._events[type];\n\n  return this;\n};\n\nEventEmitter.prototype.listeners = function(type) {\n  var ret;\n  if (!this._events || !this._events[type])\n    ret = [];\n  else if (isFunction(this._events[type]))\n    ret = [this._events[type]];\n  else\n    ret = this._events[type].slice();\n  return ret;\n};\n\nEventEmitter.listenerCount = function(emitter, type) {\n  var ret;\n  if (!emitter._events || !emitter._events[type])\n    ret = 0;\n  else if (isFunction(emitter._events[type]))\n    ret = 1;\n  else\n    ret = emitter._events[type].length;\n  return ret;\n};\n\nfunction isFunction(arg) {\n  return typeof arg === 'function';\n}\n\nfunction isNumber(arg) {\n  return typeof arg === 'number';\n}\n\nfunction isObject(arg) {\n  return typeof arg === 'object' && arg !== null;\n}\n\nfunction isUndefined(arg) {\n  return arg === void 0;\n}\n","module.exports = XMLHttpRequest;","if (typeof Object.create === 'function') {\n  // implementation from standard node.js 'util' module\n  module.exports = function inherits(ctor, superCtor) {\n    ctor.super_ = superCtor\n    ctor.prototype = Object.create(superCtor.prototype, {\n      constructor: {\n        value: ctor,\n        enumerable: false,\n        writable: true,\n        configurable: true\n      }\n    });\n  };\n} else {\n  // old school shim for old browsers\n  module.exports = function inherits(ctor, superCtor) {\n    ctor.super_ = superCtor\n    var TempCtor = function () {}\n    TempCtor.prototype = superCtor.prototype\n    ctor.prototype = new TempCtor()\n    ctor.prototype.constructor = ctor\n  }\n}\n","/*\n * (C) Copyright 2014 Kurento (http://kurento.org/)\n *\n * All rights reserved. This program and the accompanying materials\n * are made available under the terms of the GNU Lesser General Public License\n * (LGPL) version 2.1 which accompanies this distribution, and is available at\n * http://www.gnu.org/licenses/lgpl-2.1.html\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n * Lesser General Public License for more details.\n *\n */\n\nvar EventEmitter = require('events').EventEmitter;\n\nvar inherits = require('inherits');\n\nvar packers = require('./packers');\nvar Mapper = require('./Mapper');\n\n\nconst BASE_TIMEOUT = 5000;\n\n\nfunction unifyResponseMethods(responseMethods)\n{\n  if(!responseMethods) return {};\n\n  for(var key in responseMethods)\n  {\n    var value = responseMethods[key];\n\n    if(typeof value == 'string')\n      responseMethods[key] =\n      {\n        response: value\n      }\n  };\n\n  return responseMethods;\n};\n\nfunction unifyTransport(transport)\n{\n  if(!transport) return;\n\n  // Transport as a function\n  if(transport instanceof Function)\n    return {send: transport};\n\n  // WebSocket & DataChannel\n  if(transport.send instanceof Function)\n    return transport;\n\n  // Message API (Inter-window & WebWorker)\n  if(transport.postMessage instanceof Function)\n  {\n    transport.send = transport.postMessage;\n    return transport;\n  }\n\n  // Stream API\n  if(transport.write instanceof Function)\n  {\n    transport.send = transport.write;\n    return transport;\n  }\n\n  // Transports that only can receive messages, but not send\n  if(transport.onmessage !== undefined) return;\n  if(transport.pause instanceof Function) return;\n\n  throw new SyntaxError(\"Transport is not a function nor a valid object\");\n};\n\n\n/**\n * Representation of a RPC notification\n *\n * @class\n *\n * @constructor\n *\n * @param {String} method -method of the notification\n * @param params - parameters of the notification\n */\nfunction RpcNotification(method, params)\n{\n  Object.defineProperty(this, 'method', {value: method, enumerable: true});\n  Object.defineProperty(this, 'params', {value: params, enumerable: true});\n};\n\n\n/**\n * @class\n *\n * @constructor\n *\n * @param {object} packer\n *\n * @param {object} [options]\n *\n * @param {object} [transport]\n *\n * @param {Function} [onRequest]\n */\nfunction RpcBuilder(packer, options, transport, onRequest)\n{\n  var self = this;\n\n  if(!packer)\n    throw new SyntaxError('Packer is not defined');\n\n  if(!packer.pack || !packer.unpack)\n    throw new SyntaxError('Packer is invalid');\n\n  var responseMethods = unifyResponseMethods(packer.responseMethods);\n\n\n  if(options instanceof Function)\n  {\n    if(transport != undefined)\n      throw new SyntaxError(\"There can't be parameters after onRequest\");\n\n    onRequest = options;\n    transport = undefined;\n    options   = undefined;\n  };\n\n  if(options && options.send instanceof Function)\n  {\n    if(transport && !(transport instanceof Function))\n      throw new SyntaxError(\"Only a function can be after transport\");\n\n    onRequest = transport;\n    transport = options;\n    options   = undefined;\n  };\n\n  if(transport instanceof Function)\n  {\n    if(onRequest != undefined)\n      throw new SyntaxError(\"There can't be parameters after onRequest\");\n\n    onRequest = transport;\n    transport = undefined;\n  };\n\n  if(transport && transport.send instanceof Function)\n    if(onRequest && !(onRequest instanceof Function))\n      throw new SyntaxError(\"Only a function can be after transport\");\n\n  options = options || {};\n\n\n  EventEmitter.call(this);\n\n  if(onRequest)\n    this.on('request', onRequest);\n\n\n  Object.defineProperty(this, 'peerID', {value: options.peerID});\n\n  var max_retries = options.max_retries || 0;\n\n\n  function transportMessage(event)\n  {\n    self.decode(event.data || event);\n  };\n\n  Object.defineProperty(this, 'transport',\n  {\n    get: function()\n    {\n      return transport;\n    },\n\n    set: function(value)\n    {\n      // Remove listener from old transport\n      if(transport)\n      {\n        // W3C transports\n        if(transport.removeEventListener)\n          transport.removeEventListener('message', transportMessage);\n\n        // Node.js Streams API\n        else if(transport.removeListener)\n          transport.removeListener('data', transportMessage);\n      };\n\n      // Set listener on new transport\n      if(value)\n      {\n        // W3C transports\n        if(value.addEventListener)\n          value.addEventListener('message', transportMessage);\n\n        // Node.js Streams API\n        else if(value.addListener)\n          value.addListener('data', transportMessage);\n      };\n\n      transport = unifyTransport(value);\n    }\n  })\n\n  this.transport = transport;\n\n\n  const request_timeout    = options.request_timeout    || BASE_TIMEOUT;\n  const response_timeout   = options.response_timeout   || BASE_TIMEOUT;\n  const duplicates_timeout = options.duplicates_timeout || BASE_TIMEOUT;\n\n\n  var requestID = 0;\n\n  var requests  = new Mapper();\n  var responses = new Mapper();\n  var processedResponses = new Mapper();\n\n  var message2Key = {};\n\n\n  /**\n   * Store the response to prevent to process duplicate request later\n   */\n  function storeResponse(message, id, dest)\n  {\n    var response =\n    {\n      message: message,\n      /** Timeout to auto-clean old responses */\n      timeout: setTimeout(function()\n      {\n        responses.remove(id, dest);\n      },\n      response_timeout)\n    };\n\n    responses.set(response, id, dest);\n  };\n\n  /**\n   * Store the response to ignore duplicated messages later\n   */\n  function storeProcessedResponse(ack, from)\n  {\n    var timeout = setTimeout(function()\n    {\n      processedResponses.remove(ack, from);\n    },\n    duplicates_timeout);\n\n    processedResponses.set(timeout, ack, from);\n  };\n\n\n  /**\n   * Representation of a RPC request\n   *\n   * @class\n   * @extends RpcNotification\n   *\n   * @constructor\n   *\n   * @param {String} method -method of the notification\n   * @param params - parameters of the notification\n   * @param {Integer} id - identifier of the request\n   * @param [from] - source of the notification\n   */\n  function RpcRequest(method, params, id, from, transport)\n  {\n    RpcNotification.call(this, method, params);\n\n    Object.defineProperty(this, 'transport',\n    {\n      get: function()\n      {\n        return transport;\n      },\n\n      set: function(value)\n      {\n        transport = unifyTransport(value);\n      }\n    })\n\n    var response = responses.get(id, from);\n\n    /**\n     * @constant {Boolean} duplicated\n     */\n    if(!(transport || self.transport))\n      Object.defineProperty(this, 'duplicated',\n      {\n        value: Boolean(response)\n      });\n\n    var responseMethod = responseMethods[method];\n\n    this.pack = packer.pack.bind(packer, this, id)\n\n    /**\n     * Generate a response to this request\n     *\n     * @param {Error} [error]\n     * @param {*} [result]\n     *\n     * @returns {string}\n     */\n    this.reply = function(error, result, transport)\n    {\n      // Fix optional parameters\n      if(error instanceof Function || error && error.send instanceof Function)\n      {\n        if(result != undefined)\n          throw new SyntaxError(\"There can't be parameters after callback\");\n\n        transport = error;\n        result = null;\n        error = undefined;\n      }\n\n      else if(result instanceof Function\n      || result && result.send instanceof Function)\n      {\n        if(transport != undefined)\n          throw new SyntaxError(\"There can't be parameters after callback\");\n\n        transport = result;\n        result = null;\n      };\n\n      transport = unifyTransport(transport);\n\n      // Duplicated request, remove old response timeout\n      if(response)\n        clearTimeout(response.timeout);\n\n      if(from != undefined)\n      {\n        if(error)\n          error.dest = from;\n\n        if(result)\n          result.dest = from;\n      };\n\n      var message;\n\n      // New request or overriden one, create new response with provided data\n      if(error || result != undefined)\n      {\n        if(self.peerID != undefined)\n        {\n          if(error)\n            error.from = self.peerID;\n          else\n            result.from = self.peerID;\n        }\n\n        // Protocol indicates that responses has own request methods\n        if(responseMethod)\n        {\n          if(responseMethod.error == undefined && error)\n            message =\n            {\n              error: error\n            };\n\n          else\n          {\n            var method = error\n                       ? responseMethod.error\n                       : responseMethod.response;\n\n            message =\n            {\n              method: method,\n              params: error || result\n            };\n          }\n        }\n        else\n          message =\n          {\n            error:  error,\n            result: result\n          };\n\n        message = packer.pack(message, id);\n      }\n\n      // Duplicate & not-overriden request, re-send old response\n      else if(response)\n        message = response.message;\n\n      // New empty reply, response null value\n      else\n        message = packer.pack({result: null}, id);\n\n      // Store the response to prevent to process a duplicated request later\n      storeResponse(message, id, from);\n\n      // Return the stored response so it can be directly send back\n      transport = transport || this.transport || self.transport;\n\n      if(transport)\n        return transport.send(message);\n\n      return message;\n    }\n  };\n  inherits(RpcRequest, RpcNotification);\n\n\n  function cancel(message)\n  {\n    var key = message2Key[message];\n    if(!key) return;\n\n    delete message2Key[message];\n\n    var request = requests.pop(key.id, key.dest);\n    if(!request) return;\n\n    clearTimeout(request.timeout);\n\n    // Start duplicated responses timeout\n    storeProcessedResponse(key.id, key.dest);\n  };\n\n  /**\n   * Allow to cancel a request and don't wait for a response\n   *\n   * If `message` is not given, cancel all the request\n   */\n  this.cancel = function(message)\n  {\n    if(message) return cancel(message);\n\n    for(var message in message2Key)\n      cancel(message);\n  };\n\n\n  this.close = function()\n  {\n    // Prevent to receive new messages\n    var transport = self.transport;\n    if(transport && transport.close)\n       transport.close();\n\n    // Request & processed responses\n    this.cancel();\n\n    processedResponses.forEach(clearTimeout);\n\n    // Responses\n    responses.forEach(function(response)\n    {\n      clearTimeout(response.timeout);\n    });\n  };\n\n\n  /**\n   * Generates and encode a JsonRPC 2.0 message\n   *\n   * @param {String} method -method of the notification\n   * @param params - parameters of the notification\n   * @param [dest] - destination of the notification\n   * @param {object} [transport] - transport where to send the message\n   * @param [callback] - function called when a response to this request is\n   *   received. If not defined, a notification will be send instead\n   *\n   * @returns {string} A raw JsonRPC 2.0 request or notification string\n   */\n  this.encode = function(method, params, dest, transport, callback)\n  {\n    // Fix optional parameters\n    if(params instanceof Function)\n    {\n      if(dest != undefined)\n        throw new SyntaxError(\"There can't be parameters after callback\");\n\n      callback  = params;\n      transport = undefined;\n      dest      = undefined;\n      params    = undefined;\n    }\n\n    else if(dest instanceof Function)\n    {\n      if(transport != undefined)\n        throw new SyntaxError(\"There can't be parameters after callback\");\n\n      callback  = dest;\n      transport = undefined;\n      dest      = undefined;\n    }\n\n    else if(transport instanceof Function)\n    {\n      if(callback != undefined)\n        throw new SyntaxError(\"There can't be parameters after callback\");\n\n      callback  = transport;\n      transport = undefined;\n    };\n\n    if(self.peerID != undefined)\n    {\n      params = params || {};\n\n      params.from = self.peerID;\n    };\n\n    if(dest != undefined)\n    {\n      params = params || {};\n\n      params.dest = dest;\n    };\n\n    // Encode message\n    var message =\n    {\n      method: method,\n      params: params\n    };\n\n    if(callback)\n    {\n      var id = requestID++;\n      var retried = 0;\n\n      message = packer.pack(message, id);\n\n      function dispatchCallback(error, result)\n      {\n        self.cancel(message);\n\n        callback(error, result);\n      };\n      \n      var request =\n      {\n        message:         message,\n        callback:        dispatchCallback,\n        responseMethods: responseMethods[method] || {}\n      };\n\n      var request =\n      {\n        message:         message,\n        callback:        dispatchCallback,\n        responseMethods: responseMethods[method] || {}\n      };\n\n      var encode_transport = unifyTransport(transport);\n\n      function sendRequest(transport)\n      {\n        request.timeout = setTimeout(timeout,\n                                     request_timeout*Math.pow(2, retried++));\n        message2Key[message] = {id: id, dest: dest};\n        requests.set(request, id, dest);\n\n        transport = transport || encode_transport || self.transport;\n        if(transport)\n          return transport.send(message);\n\n        return message;\n      };\n\n      function retry(transport)\n      {\n        transport = unifyTransport(transport);\n\n        console.warn(retried+' retry for request message:',message);\n\n        var timeout = processedResponses.pop(id, dest);\n        clearTimeout(timeout);\n\n        return sendRequest(transport);\n      };\n\n      function timeout()\n      {\n        if(retried < max_retries)\n          return retry(transport);\n\n        var error = new Error('Request has timed out');\n            error.request = message;\n\n        error.retry = retry;\n\n        dispatchCallback(error)\n      };\n\n      return sendRequest(transport);\n    };\n\n    // Return the packed message\n    message = packer.pack(message);\n\n    transport = transport || self.transport;\n    if(transport)\n      return transport.send(message);\n\n    return message;\n  };\n\n  /**\n   * Decode and process a JsonRPC 2.0 message\n   *\n   * @param {string} message - string with the content of the message\n   *\n   * @returns {RpcNotification|RpcRequest|undefined} - the representation of the\n   *   notification or the request. If a response was processed, it will return\n   *   `undefined` to notify that it was processed\n   *\n   * @throws {TypeError} - Message is not defined\n   */\n  this.decode = function(message, transport)\n  {\n    if(!message)\n      throw new TypeError(\"Message is not defined\");\n\n    try\n    {\n      message = packer.unpack(message);\n    }\n    catch(e)\n    {\n      // Ignore invalid messages\n      return console.debug(e, message);\n    };\n\n    var id     = message.id;\n    var ack    = message.ack;\n    var method = message.method;\n    var params = message.params || {};\n\n    var from = params.from;\n    var dest = params.dest;\n\n    // Ignore messages send by us\n    if(self.peerID != undefined && from == self.peerID) return;\n\n    // Notification\n    if(id == undefined && ack == undefined)\n    {\n      var notification = new RpcNotification(method, params);\n\n      if(self.emit('request', notification)) return;\n      return notification;\n    };\n\n\n    function processRequest()\n    {\n      // If we have a transport and it's a duplicated request, reply inmediatly\n      transport = unifyTransport(transport) || self.transport;\n      if(transport)\n      {\n        var response = responses.get(id, from);\n        if(response)\n          return transport.send(response.message);\n      };\n\n      var idAck = (id != undefined) ? id : ack;\n      var request = new RpcRequest(method, params, idAck, from, transport);\n\n      if(self.emit('request', request)) return;\n      return request;\n    };\n\n    function processResponse(request, error, result)\n    {\n      request.callback(error, result);\n    };\n\n    function duplicatedResponse(timeout)\n    {\n      console.warn(\"Response already processed\", message);\n\n      // Update duplicated responses timeout\n      clearTimeout(timeout);\n      storeProcessedResponse(ack, from);\n    };\n\n\n    // Request, or response with own method\n    if(method)\n    {\n      // Check if it's a response with own method\n      if(dest == undefined || dest == self.peerID)\n      {\n        var request = requests.get(ack, from);\n        if(request)\n        {\n          var responseMethods = request.responseMethods;\n\n          if(method == responseMethods.error)\n            return processResponse(request, params);\n\n          if(method == responseMethods.response)\n            return processResponse(request, null, params);\n\n          return processRequest();\n        }\n\n        var processed = processedResponses.get(ack, from);\n        if(processed)\n          return duplicatedResponse(processed);\n      }\n\n      // Request\n      return processRequest();\n    };\n\n    var error  = message.error;\n    var result = message.result;\n\n    // Ignore responses not send to us\n    if(error  && error.dest  && error.dest  != self.peerID) return;\n    if(result && result.dest && result.dest != self.peerID) return;\n\n    // Response\n    var request = requests.get(ack, from);\n    if(!request)\n    {\n      var processed = processedResponses.get(ack, from);\n      if(processed)\n        return duplicatedResponse(processed);\n\n      return console.warn(\"No callback was defined for this message\", message);\n    };\n\n    // Process response\n    processResponse(request, error, result);\n  };\n};\ninherits(RpcBuilder, EventEmitter);\n\n\nRpcBuilder.RpcNotification = RpcNotification;\n\n\nmodule.exports = RpcBuilder;\n\nvar clients = require('./clients');\n\nRpcBuilder.clients = clients;\nRpcBuilder.packers = packers;\n","function Mapper()\n{\n  var sources = {};\n\n\n  this.forEach = function(callback)\n  {\n    for(var key in sources)\n    {\n      var source = sources[key];\n\n      for(var key2 in source)\n        callback(source[key2]);\n    };\n  };\n\n  this.get = function(id, source)\n  {\n    var ids = sources[source];\n    if(ids == undefined)\n      return undefined;\n\n    return ids[id];\n  };\n\n  this.remove = function(id, source)\n  {\n    var ids = sources[source];\n    if(ids == undefined)\n      return;\n\n    delete ids[id];\n\n    if(!Object.keys(ids).length)\n      delete sources[source];\n  };\n\n  this.set = function(value, id, source)\n  {\n    if(value == undefined)\n      return this.remove(id, source);\n\n    var ids = sources[source];\n    if(ids == undefined)\n      sources[source] = ids = {};\n\n    ids[id] = value;\n  };\n};\n\n\nMapper.prototype.pop = function(id, source)\n{\n  var value = this.get(id, source);\n  if(value == undefined)\n    return undefined;\n\n  this.remove(id, source);\n\n  return value;\n};\n\n\nmodule.exports = Mapper;\n","var JsonRPC = require('./JsonRPC');\nvar XmlRPC  = require('./XmlRPC');\n\n\nexports.JsonRPC = JsonRPC;\nexports.XmlRPC  = XmlRPC;\n","/*\n * (C) Copyright 2014 Kurento (http://kurento.org/)\n *\n * All rights reserved. This program and the accompanying materials\n * are made available under the terms of the GNU Lesser General Public License\n * (LGPL) version 2.1 which accompanies this distribution, and is available at\n * http://www.gnu.org/licenses/lgpl-2.1.html\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n * Lesser General Public License for more details.\n *\n */\n\nvar JsonRpcClient  = require('./jsonrpcclient');\n\n\nexports.JsonRpcClient  = JsonRpcClient;\n","/**\n * JsonRPC 2.0 packer\n */\n\n/**\n * Pack a JsonRPC 2.0 message\n *\n * @param {Object} message - object to be packaged. It requires to have all the\n *   fields needed by the JsonRPC 2.0 message that it's going to be generated\n *\n * @return {String} - the stringified JsonRPC 2.0 message\n */\nfunction pack(message, id)\n{\n  var result =\n  {\n    jsonrpc: \"2.0\"\n  };\n\n  // Request\n  if(message.method)\n  {\n    result.method = message.method;\n\n    if(message.params)\n      result.params = message.params;\n\n    // Request is a notification\n    if(id != undefined)\n      result.id = id;\n  }\n\n  // Response\n  else if(id != undefined)\n  {\n    if(message.error)\n    {\n      if(message.result !== undefined)\n        throw new TypeError(\"Both result and error are defined\");\n\n      result.error = message.error;\n    }\n    else if(message.result !== undefined)\n      result.result = message.result;\n    else\n      throw new TypeError(\"No result or error is defined\");\n\n    result.id = id;\n  };\n\n  return JSON.stringify(result);\n};\n\n/**\n * Unpack a JsonRPC 2.0 message\n *\n * @param {String} message - string with the content of the JsonRPC 2.0 message\n *\n * @throws {TypeError} - Invalid JsonRPC version\n *\n * @return {Object} - object filled with the JsonRPC 2.0 message content\n */\nfunction unpack(message)\n{\n  var result = message;\n\n  if(typeof message == 'string' || message instanceof String)\n    result = JSON.parse(message);\n\n  // Check if it's a valid message\n\n  var version = result.jsonrpc;\n  if(version != \"2.0\")\n    throw new TypeError(\"Invalid JsonRPC version '\"+version+\"': \"+message);\n\n  // Response\n  if(result.method == undefined)\n  {\n    if(result.id == undefined)\n      throw new TypeError(\"Invalid message: \"+message);\n\n    var result_defined = result.result !== undefined;\n    var error_defined  = result.error  !== undefined;\n\n    // Check only result or error is defined, not both or none\n    if(result_defined && error_defined)\n      throw new TypeError(\"Both result and error are defined: \"+message);\n\n    if(!result_defined && !error_defined)\n      throw new TypeError(\"No result or error is defined: \"+message);\n\n    result.ack = result.id;\n    delete result.id;\n  }\n\n  // Return unpacked message\n  return result;\n};\n\n\nexports.pack   = pack;\nexports.unpack = unpack;\n","function pack(message)\n{\n  throw new TypeError(\"Not yet implemented\");\n};\n\nfunction unpack(message)\n{\n  throw new TypeError(\"Not yet implemented\");\n};\n\n\nexports.pack   = pack;\nexports.unpack = unpack;\n","/*\n * (C) Copyright 2014 Kurento (http://kurento.org/)\n *\n * All rights reserved. This program and the accompanying materials\n * are made available under the terms of the GNU Lesser General Public License\n * (LGPL) version 2.1 which accompanies this distribution, and is available at\n * http://www.gnu.org/licenses/lgpl-2.1.html\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n * Lesser General Public License for more details.\n *\n */\n\nvar RpcBuilder = require('../..');\n\nvar WebSocket = require('ws');\n\n\nfunction JsonRpcClient(wsUrl, onRequest, onerror)\n{\n  var ws = new WebSocket(wsUrl);\n      ws.addEventListener('error', onerror);\n\n  var rpc = new RpcBuilder(RpcBuilder.packers.JsonRPC, ws, onRequest);\n\n  this.close       = rpc.close.bind(rpc);\n  this.sendRequest = rpc.encode.bind(rpc);\n};\n\n\nmodule.exports  = JsonRpcClient;\n","\n/**\n * Module dependencies.\n */\n\nvar global = (function() { return this; })();\n\n/**\n * WebSocket constructor.\n */\n\nvar WebSocket = global.WebSocket || global.MozWebSocket;\n\n/**\n * Module exports.\n */\n\nmodule.exports = WebSocket ? ws : null;\n\n/**\n * WebSocket constructor.\n *\n * The third `opts` options object gets ignored in web browsers, since it's\n * non-standard, and throws a TypeError if passed to the constructor.\n * See: https://github.com/einaros/ws/issues/227\n *\n * @param {String} uri\n * @param {Array} protocols (optional)\n * @param {Object) opts (optional)\n * @api public\n */\n\nfunction ws(uri, protocols, opts) {\n  var instance;\n  if (protocols) {\n    instance = new WebSocket(uri, protocols);\n  } else {\n    instance = new WebSocket(uri);\n  }\n  return instance;\n}\n\nif (WebSocket) ws.prototype = WebSocket.prototype;\n"]}